(function(){function n(e){if(e)return function(e){for(var t in n.prototype)e[t]=n.prototype[t];return e}(e)}n.prototype.on=n.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},n.prototype.once=function(e,t){var n=this;function o(){n.off(e,o),t.apply(this,arguments)}return this._callbacks=this._callbacks||{},o.fn=t,this.on(e,o),this},n.prototype.off=n.prototype.removeListener=n.prototype.removeAllListeners=n.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,o=this._callbacks[e];if(!o)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var r=0;r<o.length;r++)if((n=o[r])===t||n.fn===t){o.splice(r,1);break}return this},n.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks[e];if(n)for(var o=0,r=(n=n.slice(0)).length;o<r;++o)n[o].apply(this,t);return this},n.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},n.prototype.hasListeners=function(e){return!!this.listeners(e).length},"undefined"!=typeof window&&(window.EventEmitter=n)})(),function(e,h,t){var v=e,n=v.Package={},r=v.Message={};n.TYPE_HANDSHAKE=1,n.TYPE_HANDSHAKE_ACK=2,n.TYPE_HEARTBEAT=3,n.TYPE_DATA=4,n.TYPE_KICK=5,r.TYPE_REQUEST=0,r.TYPE_NOTIFY=1,r.TYPE_RESPONSE=2,r.TYPE_PUSH=3,v.strencode=function(e){for(var t=new h(3*e.length),n=0,o=0;o<e.length;o++){var r=e.charCodeAt(o),i=null;i=r<=127?[r]:r<=2047?[192|r>>6,128|63&r]:[224|r>>12,128|(4032&r)>>6,128|63&r];for(var c=0;c<i.length;c++)t[n]=i[c],++n}var s=new h(n);return y(s,0,t,0,n),s},v.strdecode=function(e){for(var t=new h(e),n=[],o=0,r=0,i=t.length;o<i;)t[o]<128?(r=t[o],o+=1):t[o]<224?(r=((63&t[o])<<6)+(63&t[o+1]),o+=2):(r=((15&t[o])<<12)+((63&t[o+1])<<6)+(63&t[o+2]),o+=3),n.push(r);return String.fromCharCode.apply(null,n)},n.encode=function(e,t){var n=t?t.length:0,o=new h(4+n),r=0;return o[r++]=255&e,o[r++]=n>>16&255,o[r++]=n>>8&255,o[r++]=255&n,t&&y(o,4,t,0,n),o},n.decode=function(e){for(var t=0,n=new h(e),o=0,r=[];t<n.length;){var i=n[t++],c=(o=(n[t++]<<16|n[t++]<<8|n[t++])>>>0)?new h(o):null;y(c,0,n,t,o),t+=o,r.push({type:i,body:c})}return 1===r.length?r[0]:r},r.encode=function(e,t,n,o,r){var i=1+(g(t)?a(e):0);if(w(t))if(n){if("number"!=typeof o)throw new Error("error flag for number route!");i+=2}else if(i+=1,o){if(255<(o=v.strencode(o)).length)throw new Error("route maxlength is overflow");i+=o.length}r&&(i+=r.length);var c=new h(i),s=0;return s=u(t,n,c,s),g(t)&&(s=f(e,c,s)),w(t)&&(s=l(n,o,c,s)),r&&(s=d(r,c,s)),c},r.decode=function(e){var t=new h(e),n=t.length||t.byteLength,o=0,r=0,i=null,c=t[o++],s=1&c,a=c>>1&7;if(g(a)){var u=parseInt(t[o]),f=0;do{r+=(127&(u=parseInt(t[o])))*Math.pow(2,7*f),o++,f++}while(128<=u)}if(w(a))if(s)i=t[o++]<<8|t[o++];else{var l=t[o++];l?(i=new h(l),y(i,0,t,o,l),i=v.strdecode(i)):i="",o+=l}var d=n-o,p=new h(d);return y(p,0,t,o,d),{id:r,type:a,compressRoute:s,route:i,body:p}};var y=function(e,t,n,o,r){if("function"==typeof n.copy)n.copy(e,t,o,o+r);else for(var i=0;i<r;i++)e[t++]=n[o++]},g=function(e){return e===r.TYPE_REQUEST||e===r.TYPE_RESPONSE},w=function(e){return e===r.TYPE_REQUEST||e===r.TYPE_NOTIFY||e===r.TYPE_PUSH},a=function(e){for(var t=0;t+=1,0<(e>>=7););return t},u=function(e,t,n,o){if(e!==r.TYPE_REQUEST&&e!==r.TYPE_NOTIFY&&e!==r.TYPE_RESPONSE&&e!==r.TYPE_PUSH)throw new Error("unkonw message type: "+e);return n[o]=e<<1|(t?1:0),o+1},f=function(e,t,n){do{var o=e%128,r=Math.floor(e/128);0!==r&&(o+=128),t[n++]=o,e=r}while(0!==e);return n},l=function(e,t,n,o){if(e){if(65535<t)throw new Error("route number is overflow");n[o++]=t>>8&255,n[o++]=255&t}else t?(n[o++]=255&t.length,y(n,o,t,0,t.length),o+=t.length):n[o++]=0;return o},d=function(e,t,n){return y(t,n,e,0,e.length),n+e.length};"undefined"!=typeof window&&(window.Protocol=v)}("undefined"==typeof window?module.exports:{},"undefined"==typeof window?Buffer:Uint8Array),function(e,t){var n=typeof window=="undefined"?module.exports:{};n.init=function(e){n.encoder.init(e.encoderProtos),n.decoder.init(e.decoderProtos)},n.encode=function(e,t){return n.encoder.encode(e,t)},n.decode=function(e,t){return n.decoder.decode(e,t)},"undefined"!=typeof window&&(window.protobuf=n)}(),(("undefined"!=typeof protobuf?protobuf:module.exports).constants={}).TYPES={uInt32:0,sInt32:0,int32:0,double:1,string:2,message:2,float:5},(("undefined"!=typeof protobuf?protobuf:module.exports).util={}).isSimpleType=function(e){return"uInt32"===e||"sInt32"===e||"int32"===e||"uInt64"===e||"sInt64"===e||"float"===e||"double"===e},function(e,t){var n=("undefined"!==typeof protobuf?protobuf:module.exports).codec={},o=new ArrayBuffer(8),r=new Float32Array(o),i=new Float64Array(o),c=new Uint8Array(o);function s(e){return e<=127?[e]:e<=2047?[192|e>>6,128|63&e]:[224|e>>12,128|(4032&e)>>6,128|63&e]}function a(e){return e<=127?1:e<=2047?2:3}n.encodeUInt32=function(e){e=parseInt(e);if(isNaN(e)||e<0)return null;var t=[];do{var n=e%128,o=Math.floor(e/128);0!==o&&(n+=128),t.push(n),e=o}while(0!==e);return t},n.encodeSInt32=function(e){e=parseInt(e);return isNaN(e)?null:(e=e<0?2*Math.abs(e)-1:2*e,n.encodeUInt32(e))},n.decodeUInt32=function(e){for(var t=0,n=0;n<e.length;n++){var o=parseInt(e[n]);if(t+=(127&o)*Math.pow(2,7*n),o<128)return t}return t},n.decodeSInt32=function(e){var t=this.decodeUInt32(e);return t=(t%2+t)/2*(t%2==1?-1:1)},n.encodeFloat=function(e){return r[0]=e,c},n.decodeFloat=function(e,t){if(!e||e.length<t+4)return null;for(var n=0;n<4;n++)c[n]=e[t+n];return r[0]},n.encodeDouble=function(e){return i[0]=e,c.subarray(0,8)},n.decodeDouble=function(e,t){if(!e||e.length<t+8)return null;for(var n=0;n<8;n++)c[n]=e[t+n];return i[0]},n.encodeStr=function(e,t,n){for(var o=0;o<n.length;o++)for(var r=s(n.charCodeAt(o)),i=0;i<r.length;i++)e[t]=r[i],t++;return t},n.decodeStr=function(e,t,n){for(var o=[],r=t+n;t<r;){var i=0;e[t]<128?(i=e[t],t+=1):e[t]<224?(i=((63&e[t])<<6)+(63&e[t+1]),t+=2):(i=((15&e[t])<<12)+((63&e[t+1])<<6)+(63&e[t+2]),t+=3),o.push(i)}for(var c="",s=0;s<o.length;)c+=String.fromCharCode.apply(null,o.slice(s,s+1e4)),s+=1e4;return c},n.byteLength=function(e){if("string"!=typeof e)return-1;for(var t=0,n=0;n<e.length;n++){t+=a(e.charCodeAt(n))}return t}}(),function(e,t){var n=e,u=e.encoder={},f=n.codec,o=n.constants,c=n.util;function l(e,t,n,o){for(var r in o)if(n[r]){var i=n[r];switch(i.option){case"required":case"optional":t=d(e,t,p(i.type,i.tag)),t=s(o[r],i.type,t,e,n);break;case"repeated":0<o[r].length&&(t=a(o[r],i,t,e,n))}}return t}function s(e,t,n,o,r){switch(t){case"uInt32":n=d(o,n,f.encodeUInt32(e));break;case"int32":case"sInt32":n=d(o,n,f.encodeSInt32(e));break;case"float":d(o,n,f.encodeFloat(e)),n+=4;break;case"double":d(o,n,f.encodeDouble(e)),n+=8;break;case"string":var i=f.byteLength(e);n=d(o,n,f.encodeUInt32(i)),f.encodeStr(o,n,e),n+=i;break;default:var c=r.__messages[t]||u.protos["message "+t];if(c){var s=new ArrayBuffer(2*f.byteLength(JSON.stringify(e)));i=l(s,i=0,c,e),n=d(o,n,f.encodeUInt32(i));for(var a=0;a<i;a++)o[n]=s[a],n++}}return n}function a(e,t,n,o,r){var i=0;if(c.isSimpleType(t.type))for(n=d(o,n=d(o,n,p(t.type,t.tag)),f.encodeUInt32(e.length)),i=0;i<e.length;i++)n=s(e[i],t.type,n,o);else for(i=0;i<e.length;i++)n=d(o,n,p(t.type,t.tag)),n=s(e[i],t.type,n,o,r);return n}function d(e,t,n){for(var o=0;o<n.length;o++,t++)e[t]=n[o];return t}function p(e,t){var n=o.TYPES[e]||2;return f.encodeUInt32(t<<3|n)}u.init=function(e){this.protos=e||{}},u.encode=function(e,t){var n=this.protos[e];if(!function e(t,n){if(!n)return!1;for(var o in n){var r=n[o];switch(r.option){case"required":if(void 0===t[o])return console.warn("no property exist for required! name: %j, proto: %j, msg: %j",o,r,t),!1;case"optional":if(void 0!==t[o]){var i=n.__messages[r.type]||u.protos["message "+r.type];if(i&&!e(t[o],i))return console.warn("inner proto error! name: %j, proto: %j, msg: %j",o,r,t),!1}break;case"repeated":var i=n.__messages[r.type]||u.protos["message "+r.type];if(t[o]&&i)for(var c=0;c<t[o].length;c++)if(!e(t[o][c],i))return!1}}return!0}(t,n))return null;var o=f.byteLength(JSON.stringify(t)),r=new ArrayBuffer(o),i=new Uint8Array(r),c=0;return n&&0<(c=l(i,c,n,t))?i.subarray(0,c):null}}("undefined"!=typeof protobuf?protobuf:module.exports),function(e,t){var a,n=e,u=e.decoder={},f=n.codec,i=n.util,l=0;function d(e,t,n){for(;l<n;){var o=(void 0,{type:7&(c=f.decodeUInt32(h())),tag:c>>3}),r=o.tag,i=t.__tags[r];switch(t[i].option){case"optional":case"required":e[i]=s(t[i].type,t);break;case"repeated":e[i]||(e[i]=[]),p(e[i],t[i].type,t)}}var c;return e}function s(e,t){switch(e){case"uInt32":return f.decodeUInt32(h());case"int32":case"sInt32":return f.decodeSInt32(h());case"float":var n=f.decodeFloat(a,l);return l+=4,n;case"double":var o=f.decodeDouble(a,l);return l+=8,o;case"string":var r=f.decodeUInt32(h()),i=f.decodeStr(a,l,r);return l+=r,i;default:var c=t&&(t.__messages[e]||u.protos["message "+e]);if(c){r=f.decodeUInt32(h());var s={};return d(s,c,l+r),s}}}function p(e,t,n){if(i.isSimpleType(t))for(var o=f.decodeUInt32(h()),r=0;r<o;r++)e.push(s(t));else e.push(s(t,n))}function h(e){var t,n=[],o=l;for(e=e||!1;t=a[o],n.push(t),o++,128<=t;);return e||(l=o),n}u.init=function(e){this.protos=e||{}},u.setProtos=function(e){e&&(this.protos=e)},u.decode=function(e,t){var n=this.protos[e];return a=t,l=0,n?d({},n,a.length):null}}("undefined"!=typeof protobuf?protobuf:module.exports),function(){var i=window.Protocol,c=window.protobuf,s=window.decodeIO_protobuf,a=null,u=null,f=i.Package,l=i.Message,e=window.EventEmitter,d=window.rsa,p=null;"undefined"!=typeof window&&"undefined"!=typeof sys&&sys.localStorage&&(window.localStorage=sys.localStorage);"function"!=typeof Object.create&&(Object.create=function(e){function t(){}return t.prototype=e,new t});var t=window,h=Object.create(e.prototype);t.pomelo=h;var v,y=null,o=0,r={},g={},w={},b={},E={},m={},_={},T=0,n=0,S=0,P=0,I=null,k=null,A=null,Y=null,N=null,U=!1,O=null,H=null,D=0,J=5e3,R={sys:{type:"js-websocket",version:"0.0.1",rsa:{}},user:{}},C=null;h.init=function(e,t){C=t;var n=e.host,o=e.port;N=e.encode||j,Y=e.decode||K;var r="ws://"+n;if(o&&(r+=":"+o),R.user=e.user,e.encrypt){v=!0,d.generate(1024,"10001");var i={rsa_n:d.n.toString(16),rsa_e:d.e};R.sys.rsa=i}A=e.handshakeCallback,x(e,r,t)};var K=h.decode=function(e){var t=l.decode(e);if(!(0<t.id)||(t.route=w[t.id],delete w[t.id],t.route))return t.body=V(t),t},j=h.encode=function(e,t,n){var o=e?l.TYPE_REQUEST:l.TYPE_NOTIFY;if(c&&_[t])n=c.encode(t,n);else if(a&&a.lookup(t)){n=new(a.build(t))(n).encodeNB()}else n=i.strencode(JSON.stringify(n));var r=0;return b&&b[t]&&(t=b[t],r=1),l.encode(e,o,r,t,n)},x=function(t,e,n){console.log("connect to "+e);var o=(t=t||{}).maxReconnectAttempts||10;if(H=e,window.localStorage&&window.localStorage.getItem("protos")&&0===T){var r=JSON.parse(window.localStorage.getItem("protos"));T=r.version||0,m=r.server||{},_=r.client||{},c&&c.init({encoderProtos:_,decoderProtos:m}),s&&(a=s.loadJson(_),u=s.loadJson(m))}R.sys.protoVersion=T;(y=new WebSocket(e)).binaryType="arraybuffer",y.onopen=function(e){U&&h.emit("reconnect"),F();var t=f.encode(f.TYPE_HANDSHAKE,i.strencode(JSON.stringify(R)));B(t)},y.onmessage=function(e){q(f.decode(e.data),n),S&&(P=Date.now()+S)},y.onerror=function(e){h.emit("io-error",e),console.error("socket error: ",e)},y.onclose=function(e){h.emit("close",e),h.emit("disconnect",e),console.error("socket close: ",e),t.reconnect&&D<o&&(U=!0,D++,O=setTimeout(function(){x(t,H,n)},J),J*=2),y=null,p&&p(),p=null}};h.disconnect=function(e){p=e,y&&(y.disconnect&&y.disconnect(),y.close&&y.close(),console.log("disconnect"),y=null),I&&(clearTimeout(I),I=null),k&&(clearTimeout(k),k=null)};var F=function(){U=!1,J=5e3,D=0,clearTimeout(O)};h.request=function(e,t,n){2===arguments.length&&"function"==typeof t?(n=t,t={}):t=t||{},(e=e||t.route)&&(L(++o,e,t),r[o]=n,w[o]=e)},h.notify=function(e,t){L(0,e,t=t||{})};var L=function(e,t,n){if(v){n=JSON.stringify(n);var o=d.signString(n,"sha256");(n=JSON.parse(n)).__crypto__=o}N&&(n=N(e,t,n));var r=f.encode(f.TYPE_DATA,n);B(r)},B=function(e){null!==y&&y.send(e.buffer)},M=function(){var e=P-Date.now();100<e?k=setTimeout(M,e):(console.error("server heartbeat timeout"),h.emit("heartbeat timeout"),h.disconnect())};g[f.TYPE_HANDSHAKE]=function(e){if(501!==(e=JSON.parse(i.strdecode(e))).code)if(200===e.code){W(e);var t=f.encode(f.TYPE_HANDSHAKE_ACK);B(t),C&&C(y)}else h.emit("error","handshake fail");else h.emit("error","client version not fullfill")},g[f.TYPE_HEARTBEAT]=function(e){if(n){var t=f.encode(f.TYPE_HEARTBEAT);k&&(clearTimeout(k),k=null),I||(I=setTimeout(function(){I=null,B(t),P=Date.now()+S,k=setTimeout(M,S)},n))}},g[f.TYPE_DATA]=function(e){var t=e;Y&&(t=Y(t)),Q(h,t)},g[f.TYPE_KICK]=function(e){e=JSON.parse(i.strdecode(e)),h.emit("onKick",e)};var q=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];g[n.type](n.body)}else g[e.type](e.body)},Q=function(e,t){if(t.id){var n=r[t.id];delete r[t.id],"function"==typeof n&&n(t.body)}else e.emit(t.route,t.body)},V=function(e){var t=e.route;if(e.compressRoute){if(!E[t])return{};t=e.route=E[t]}return c&&m[t]?c.decode(t,e.body):u&&u.lookup(t)?u.build(t).decode(e.body):JSON.parse(i.strdecode(e.body))},W=function(e){e.sys&&e.sys.heartbeat?(n=1e3*e.sys.heartbeat,S=2*n):S=n=0,z(e),"function"==typeof A&&A(e.user)},z=function(e){if(e&&e.sys){b=e.sys.dict;var t=e.sys.protos;if(b)for(var n in E={},b=b)E[b[n]]=n;t&&(T=t.version||0,m=t.server||{},_=t.client||{},window.localStorage.setItem("protos",JSON.stringify(t)),c&&c.init({encoderProtos:t.client,decoderProtos:t.server}),s&&(a=s.loadJson(_),u=s.loadJson(m)))}}}();